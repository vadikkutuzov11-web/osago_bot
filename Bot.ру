import os
import telebot
from telebot import types

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Railway ===
BOT_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_CHAT_ID = os.getenv("ADMIN_CHAT_ID")  # –ø—Ä–∏–º–µ—Ä: 7263951013

if not BOT_TOKEN or not ADMIN_CHAT_ID:
    raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω—ã BOT_TOKEN –∏–ª–∏ ADMIN_CHAT_ID –≤ Variables Railway")

try:
    ADMIN_CHAT_ID = int(ADMIN_CHAT_ID)
except:
    pass  # Railway –ø–µ—Ä–µ–¥–∞–µ—Ç —Å—Ç—Ä–æ–∫—É ‚Äî TeleBot –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏ —Å—Ç—Ä–æ–∫—É, –∏ int

bot = telebot.TeleBot(BOT_TOKEN, parse_mode="HTML")

# –ü–∞–º—è—Ç—å –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
users = {}  # chat_id -> dict(step, city, reg, license, vehicle, contact)

# –•–µ–ª–ø–µ—Ä—ã
def ask_city(chat_id):
    bot.send_message(chat_id, "üìç –£–∫–∞–∂–∏—Ç–µ –≤–∞—à <b>–≥–æ—Ä–æ–¥ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è</b>:")
    users[chat_id] = {"step": "city"}

def ask_reg(chat_id):
    bot.send_message(chat_id, "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ <b>—Ñ–æ—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–ø–∏—Å–∫–∏</b> –≤ –ø–∞—Å–ø–æ—Ä—Ç–µ:")
    users[chat_id]["step"] = "reg"

def ask_license(chat_id):
    bot.send_message(chat_id, "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ <b>—Ñ–æ—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è</b> (–æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –º–æ–∂–Ω–æ –ø–æ –æ—á–µ—Ä–µ–¥–∏):")
    users[chat_id]["step"] = "license"

def ask_vehicle(chat_id):
    bot.send_message(chat_id, "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ <b>—Ñ–æ—Ç–æ –ü–¢–° –∏–ª–∏ –°–¢–°</b> (–¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –∞–≤—Ç–æ):")
    users[chat_id]["step"] = "vehicle"

def ask_contact(chat_id):
    bot.send_message(chat_id, "üìû –£–∫–∞–∂–∏—Ç–µ <b>–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</b> (WhatsApp/Telegram) –¥–ª—è —Å–≤—è–∑–∏:")
    users[chat_id]["step"] = "contact"

def send_application_to_admin(chat_id, from_user):
    u = users.get(chat_id, {})
    name = (from_user.username and f"@{from_user.username}") or from_user.first_name or "–∫–ª–∏–µ–Ω—Ç"

    # –¢–µ–∫—Å—Ç –∑–∞—è–≤–∫–∏
    text = (
        "üöó <b>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –û–°–ê–ì–û</b>\n\n"
        f"–ì–æ—Ä–æ–¥: <b>{u.get('city','‚Äî')}</b>\n"
        f"–ö–æ–Ω—Ç–∞–∫—Ç: <b>{u.get('contact','‚Äî')}</b>\n"
        f"–û—Ç: {name} (id: {chat_id})"
    )
    bot.send_message(ADMIN_CHAT_ID, text)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –ø–æ –æ—á–µ—Ä–µ–¥–∏ (–∞–ª—å–±–æ–º –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω ‚Äî —Ç–∞–∫ –Ω–∞–¥—ë–∂–Ω–µ–µ)
    if u.get("reg"):
        bot.send_photo(ADMIN_CHAT_ID, u["reg"], caption="üìÑ –ü—Ä–æ–ø–∏—Å–∫–∞")
    if u.get("license"):
        bot.send_photo(ADMIN_CHAT_ID, u["license"], caption="ü™™ –ü—Ä–∞–≤–∞")
    if u.get("vehicle"):
        bot.send_photo(ADMIN_CHAT_ID, u["vehicle"], caption="üöò –î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –∞–≤—Ç–æ")

@bot.message_handler(commands=["start", "restart", "new"])
def cmd_start(message):
    chat_id = message.chat.id
    ask_city(chat_id)

@bot.message_handler(commands=["cancel"])
def cmd_cancel(message):
    chat_id = message.chat.id
    users.pop(chat_id, None)
    bot.send_message(chat_id, "‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞. –î–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–Ω–æ–≤–æ ‚Äî /start")

@bot.message_handler(content_types=["text"])
def on_text(message):
    chat_id = message.chat.id
    step = users.get(chat_id, {}).get("step")

    if not step:
        bot.send_message(chat_id, "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ ‚Äî –Ω–∞–∂–º–∏—Ç–µ /start")
        return

    if step == "city":
        users[chat_id]["city"] = message.text.strip()
        ask_reg(chat_id)

    elif step == "contact":
        users[chat_id]["contact"] = message.text.strip()
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É
        send_application_to_admin(chat_id, message.from_user)
        bot.send_message(chat_id, "‚úÖ –°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.")
        users.pop(chat_id, None)

    else:
        bot.send_message(chat_id, "–û—Ç–ø—Ä–∞–≤—å—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ñ–æ—Ç–æ (üì∑), –∫–∞–∫ —è –ø—Ä–æ—Å–∏–ª –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ.")

@bot.message_handler(content_types=["photo"])
def on_photo(message):
    chat_id = message.chat.id
    step = users.get(chat_id, {}).get("step")

    if not step:
        bot.send_message(chat_id, "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ ‚Äî –Ω–∞–∂–º–∏—Ç–µ /start")
        return

    file_id = message.photo[-1].file_id  # –±–µ—Ä—ë–º —Å–∞–º–æ–µ —á—ë—Ç–∫–æ–µ –ø—Ä–µ–≤—å—é

    if step == "reg":
        users[chat_id]["reg"] = file_id
        ask_license(chat_id)

    elif step == "license":
        users[chat_id]["license"] = file_id
        ask_vehicle(chat_id)

    elif step == "vehicle":
        users[chat_id]["vehicle"] = file_id
        ask_contact(chat_id)

    else:
        bot.send_message(chat_id, "–ü—Ä–æ–¥–æ–ª–∂–∏–º. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –≤–≤–µ–¥–∏—Ç–µ /start")

# –ó–∞–ø—É—Å–∫
bot.polling(none_stop=True, skip_pending=True)
